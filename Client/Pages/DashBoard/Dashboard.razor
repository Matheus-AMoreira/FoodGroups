@page "/dashboard"
@using FoodGroups.Shared.DTOs
@inject IGrupoService GrupoService

<div class="dashboard-header">
    <h2>Agenda Mensal</h2>
    <div class="filters">
        <select @bind="mes" class="form-control">
            @for (int i = 1; i <= 12; i++) { 
                <option value="@i">@System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(i)</option> 
            }
        </select>
        
        <select @bind="ano" class="form-control">
            @foreach (var a in anosDisponiveis)
            {
                <option value="@a">@a</option>
            }
        </select>
        
        <button class="btn btn-primary" @onclick="CarregarAgenda">Filtrar</button>
    </div>
</div>

<div class="calendar-grid">
    @if (agendaMensal != null)
    {
        @foreach (var dia in agendaMensal)
        {
            <div class="day-card">
                <div class="day-header">@DateTime.Parse(dia.Key).ToString("dd/MM (ddd)")</div>
                <div class="day-body">
                    @foreach (var item in dia.Value)
                    {
                        <div class="meal-item @item.Refeicao.ToLower()">
                            <span class="meal-name">@item.Refeicao</span>
                            <span class="group-name">@item.Grupo</span>
                            <span class="capacity">@item.QuantidadePessoas / @item.Limite</span>
                        </div>
                    }
                </div>
            </div>
        }
    }
    else
    {
        <p>Carregando agenda...</p>
    }
</div>

@code {
    private int mes = DateTime.Now.Month;
    private int ano = DateTime.Now.Year;
    private List<int> anosDisponiveis = new(); // Lista dinâmica
    private Dictionary<string, List<ResumoRefeicaoDTO>>? agendaMensal;

    protected override async Task OnInitializedAsync()
    {
        // Gera lista: Ano atual e próximos 2 anos
        var anoAtual = DateTime.Now.Year;
        for (int i = 0; i < 3; i++)
        {
            anosDisponiveis.Add(anoAtual + i);
        }

        await CarregarAgenda();
    }

    private async Task CarregarAgenda()
    {
        agendaMensal = await GrupoService.ObterAgendaMensal(mes, ano);
    }
}