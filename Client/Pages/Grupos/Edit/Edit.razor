@page "/grupos/editar/{Id:int}"
@using FoodGroups.Shared.Models
@using FoodGroups.Shared.Validators
@using FoodGroups.Client.Components
@inject IGrupoService GrupoService
@inject IUsuarioService UsuarioService
@inject NavigationManager Navigation

<div class="edit-container">
    <div class="header-action">
        <h3>Editar Grupo</h3>
        <button class="btn btn-secondary" @onclick="Voltar">Voltar</button>
    </div>

    @if (grupo == null)
    {
        <p>Carregando dados do grupo...</p>
    }
    else
    {
        <EditForm Model="@grupo" OnValidSubmit="SalvarAlteracoes">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="card-box mb-4">
                <h4>Informações Básicas</h4>
                <div class="row">
                    <div class="col">
                        <label>Nome do Grupo</label>
                        <InputText class="form-control" @bind-Value="grupo.Nome" />
                    </div>
                    <div class="col">
                        <label>Capacidade Máxima</label>
                        <InputNumber class="form-control" @bind-Value="grupo.CapacidadeMaxima" />
                    </div>
                </div>
            </div>

            <div class="card-box mb-4">
                <h4>Agendas</h4>
                
                @if (!string.IsNullOrEmpty(erroAgenda))
                {
                    <div class="alert-error">@erroAgenda</div>
                }

                <div class="agenda-controls">
                    <div class="control-group">
                        <label>Refeição</label>
                        <InputSelect class="form-control" @bind-Value="novaAgenda.Refeicao">
                            <option value="Cafe">Café</option>
                            <option value="Almoco">Almoço</option>
                            <option value="Jantar">Jantar</option>
                        </InputSelect>
                    </div>
                    
                    <div class="control-group">
                         <label>Tipo</label>
                         <select class="form-control" @bind="ehRecorrente">
                            <option value="true">Semanal (Recorrente)</option>
                            <option value="false">Data Específica</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label>Quando</label>
                        @if (bool.Parse(ehRecorrente))
                        {
                            <InputSelect class="form-control" @bind-Value="novaAgenda.DiaSemana">
                                @foreach (var d in Enum.GetValues<DayOfWeek>()) { <option value="@d">@d</option> }
                            </InputSelect>
                        }
                        else
                        {
                            <InputDate class="form-control" @bind-Value="novaAgenda.DataEspecifica" />
                        }
                    </div>

                    <div class="control-group align-bottom">
                        <button type="button" class="btn btn-primary w-100" @onclick="AdicionarAgenda">Adicionar</button>
                    </div>
                </div>

                <ul class="list-items">
                    @foreach (var item in grupo.Agendas)
                    {
                        <li class="list-item">
                            <span class="badge @item.Refeicao.ToString().ToLower()">@item.Refeicao</span>
                            <span class="info">
                                @(item.EhRecorrente ? $"Toda {item.DiaSemana}" : item.DataEspecifica?.ToShortDateString())
                            </span>
                            <button type="button" class="btn btn-sm btn-danger" @onclick="() => grupo.Agendas.Remove(item)">Remover</button>
                        </li>
                    }
                </ul>
            </div>

            <div class="card-box mb-4">
                <h4>Membros (@grupo.Usuarios.Count / @grupo.CapacidadeMaxima)</h4>
                
                <div class="mb-3">
                    <UserSearch OnUserSelected="AdicionarMembro" />
                </div>

                @if (!string.IsNullOrEmpty(erroMembro))
                {
                    <div class="alert-error">@erroMembro</div>
                }

                <ul class="list-items">
                    @foreach (var u in grupo.Usuarios)
                    {
                        <li class="list-item">
                            <span>@u.Nome <small>(@u.Email)</small></span>
                            @if(u.Id != grupo.CriadorId) {
                                <button type="button" class="btn btn-sm btn-danger" @onclick="() => grupo.Usuarios.Remove(u)">Remover</button>
                            } else {
                                <span class="badge-owner">Dono</span>
                            }
                        </li>
                    }
                </ul>
            </div>

            <div class="actions">
                <button type="submit" class="btn btn-success btn-lg">Salvar Tudo</button>
            </div>
        </EditForm>
    }
</div>

@code {
    [Parameter] public int Id { get; set; }
    private Grupo? grupo;
    
    // Controles de UI
    private AgendaGrupo novaAgenda = new() { EhRecorrente = true, DiaSemana = DayOfWeek.Monday, DataEspecifica = DateTime.Today };
    private string ehRecorrente = "true";
    private string erroAgenda = "";
    private string erroMembro = "";

    protected override async Task OnInitializedAsync()
    {
        grupo = await GrupoService.ObterPorId(Id);
    }

    private void AdicionarAgenda()
    {
        erroAgenda = "";
        var item = new AgendaGrupo
        {
            Refeicao = novaAgenda.Refeicao,
            EhRecorrente = bool.Parse(ehRecorrente),
            DiaSemana = bool.Parse(ehRecorrente) ? novaAgenda.DiaSemana : null,
            DataEspecifica = !bool.Parse(ehRecorrente) ? novaAgenda.DataEspecifica : null,
            GrupoId = grupo!.Id 
        };

        // Validação compartilhada
        var conflito = AgendaValidator.VerificarConflito(grupo.Agendas, item);
        if (conflito != null)
        {
            erroAgenda = conflito;
            return;
        }

        grupo.Agendas.Add(item);
    }

    private void AdicionarMembro(Usuario u)
    {
        erroMembro = "";
        if (grupo!.Usuarios.Any(x => x.Id == u.Id))
        {
            erroMembro = "Este usuário já está no grupo.";
            return;
        }

        if (grupo.Usuarios.Count >= grupo.CapacidadeMaxima)
        {
            erroMembro = "Capacidade máxima atingida. Aumente a capacidade antes de adicionar.";
            return;
        }

        grupo.Usuarios.Add(u);
    }

    private async Task SalvarAlteracoes()
    {
        if (grupo != null)
        {
            await GrupoService.Atualizar(grupo.Id, grupo);
            Navigation.NavigateTo("/grupos");
        }
    }

    private void Voltar() => Navigation.NavigateTo("/grupos");
}