@page "/grupos/criar"
@using FoodGroups.Shared.DTOs
@using FoodGroups.Shared.Models
@inject IGrupoService GrupoService
@inject IUsuarioService UsuarioService
@inject NavigationManager Navigation

<h3>Criar Novo Grupo</h3>

<EditForm Model="@grupoDto" OnValidSubmit="HandleValidSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="row">
        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header">Dados do Grupo</div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Nome</label>
                        <InputText class="form-control" @bind-Value="grupoDto.Nome" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Capacidade Máxima</label>
                        <InputNumber class="form-control" @bind-Value="grupoDto.CapacidadeMaxima" />
                    </div>
                     <div class="mb-3">
                        <label class="form-label">ID do Criador (Simulado)</label>
                        <InputNumber class="form-control" @bind-Value="grupoDto.CriadorId" />
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header">Membros</div>
                <div class="card-body">
                    <div class="input-group mb-2">
                        <input class="form-control" @bind="termoBuscaUsuario" placeholder="Buscar por nome ou email..." />
                        <button type="button" class="btn btn-outline-secondary" @onclick="BuscarUsuarios">Buscar</button>
                    </div>

                    @if (usuariosEncontrados.Any())
                    {
                        <ul class="list-group mb-3">
                            @foreach (var u in usuariosEncontrados)
                            {
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    @u.Nome (@u.Email)
                                    <button type="button" class="btn btn-sm btn-success" @onclick="() => AdicionarUsuario(u)">Adicionar</button>
                                </li>
                            }
                        </ul>
                    }

                    <h6>Selecionados:</h6>
                    <ul class="list-group">
                        @foreach (var u in grupoDto.Usuarios ?? new List<Usuario>())
                        {
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                @u.Nome
                                <button type="button" class="btn btn-sm btn-danger" @onclick="() => RemoverUsuario(u)">Remover</button>
                            </li>
                        }
                        @if (grupoDto.Usuarios == null || !grupoDto.Usuarios.Any())
                        {
                            <li class="list-group-item text-muted">Nenhum membro selecionado.</li>
                        }
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-3">
        <div class="card-header">Agenda de Refeições</div>
        <div class="card-body">
            <div class="row align-items-end">
                <div class="col-md-3">
                    <label>Refeição</label>
                    <InputSelect class="form-control" @bind-Value="novaAgenda.Refeicao">
                        <option value="@TipoRefeicao.Cafe">Café</option>
                        <option value="@TipoRefeicao.Almoco">Almoço</option>
                        <option value="@TipoRefeicao.Jantar">Jantar</option>
                    </InputSelect>
                </div>
                <div class="col-md-3">
                    <label>Tipo</label>
                    <select class="form-control" @bind="tipoAgendaRecorrente">
                        <option value="true">Semanal (Recorrente)</option>
                        <option value="false">Data Específica</option>
                    </select>
                </div>
                <div class="col-md-3">
                    @if (bool.Parse(tipoAgendaRecorrente))
                    {
                        <label>Dia da Semana</label>
                        <InputSelect class="form-control" @bind-Value="novaAgenda.DiaSemana">
                            @foreach (var dia in Enum.GetValues<DayOfWeek>())
                            {
                                <option value="@dia">@dia</option>
                            }
                        </InputSelect>
                    }
                    else
                    {
                        <label>Data</label>
                        <InputDate class="form-control" @bind-Value="novaAgenda.DataEspecifica" />
                    }
                </div>
                <div class="col-md-3">
                    <button type="button" class="btn btn-secondary w-100" @onclick="AdicionarAgenda">Adicionar Agenda</button>
                </div>
            </div>

            <table class="table mt-3">
                <thead>
                    <tr>
                        <th>Refeição</th>
                        <th>Quando</th>
                        <th>Ação</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in grupoDto.Agendas)
                    {
                        <tr>
                            <td>@item.Refeicao</td>
                            <td>
                                @(item.EhRecorrente ? $"Toda {item.DiaSemana}" : item.DataEspecifica?.ToShortDateString())
                            </td>
                            <td><button type="button" class="btn btn-sm btn-danger" @onclick="() => grupoDto.Agendas.Remove(item)">Remover</button></td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary">Salvar Grupo</button>
        <a href="/grupos" class="btn btn-secondary">Cancelar</a>
    </div>
</EditForm>

@code {
    private CriarGrupoDTO grupoDto = new() { Usuarios = new(), Agendas = new(), CriadorId = 1, Nome = "", CapacidadeMaxima = 10 };
    
    // Controle de UI
    private string termoBuscaUsuario = "";
    private List<Usuario> usuariosEncontrados = new();
    
    private AgendaGrupo novaAgenda = new() { EhRecorrente = true, DiaSemana = DayOfWeek.Monday, DataEspecifica = DateTime.Today };
    private string tipoAgendaRecorrente = "true";

    private async Task BuscarUsuarios()
    {
        if (!string.IsNullOrWhiteSpace(termoBuscaUsuario))
        {
            usuariosEncontrados = await UsuarioService.BuscarUsuarios(termoBuscaUsuario);
        }
    }

    private void AdicionarUsuario(Usuario u)
    {
        if (grupoDto.Usuarios == null) grupoDto.Usuarios = new();
        if (!grupoDto.Usuarios.Any(x => x.Id == u.Id))
        {
            grupoDto.Usuarios.Add(u);
            usuariosEncontrados.Clear();
            termoBuscaUsuario = "";
        }
    }

    private void RemoverUsuario(Usuario u) => grupoDto.Usuarios?.Remove(u);

    private void AdicionarAgenda()
    {
        // Cria uma cópia para adicionar à lista
        var agenda = new AgendaGrupo
        {
            Refeicao = novaAgenda.Refeicao,
            EhRecorrente = bool.Parse(tipoAgendaRecorrente),
            DiaSemana = bool.Parse(tipoAgendaRecorrente) ? novaAgenda.DiaSemana : null,
            DataEspecifica = !bool.Parse(tipoAgendaRecorrente) ? novaAgenda.DataEspecifica : null
        };
        
        grupoDto.Agendas.Add(agenda);
    }

    private async Task HandleValidSubmit()
    {
        // Converter DTO para Model para envio (ou ajustar service para aceitar DTO se preferir)
        // O Service atual espera Model 'Grupo'
        var grupo = new Grupo
        {
            Nome = grupoDto.Nome,
            CapacidadeMaxima = grupoDto.CapacidadeMaxima,
            CriadorId = grupoDto.CriadorId,
            Usuarios = grupoDto.Usuarios ?? new(),
            Agendas = grupoDto.Agendas
        };

        var resultado = await GrupoService.CriarGrupo(grupo);
        if (resultado.Contains("sucesso"))
        {
            Navigation.NavigateTo("/grupos");
        }
        else
        {
            // Tratar erro (exibir alert ou mensagem)
            Console.WriteLine(resultado);
        }
    }
}